name: Sync Production to Staging

on:
  workflow_dispatch:
    inputs:
      confirm_sync:
        description: 'Type "CONFIRM" to proceed with the sync from production to staging'
        required: true
        type: string

jobs:
  sync-to-staging:
    runs-on: ubuntu-latest
    # Only run if the person who triggered the workflow is a repository owner/admin
    # AND they typed CONFIRM in the confirmation input
    
    if: ${{ github.event.inputs.confirm_sync == 'CONFIRM' }}
    
    steps:
      - name: Execute remote SSH commands to sync databases and media
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            # Load environment variables and profiles
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"
            
            source ~/.profile
            source ~/.bashrc
            
            # Create directory for database operations
            mkdir -p ~/db_sync
            
            # Step 1: Create a database dump from production
            echo "Creating production database dump..."
            export PGPASSWORD=${{ secrets.PROD_DB_PASSWORD }}
            pg_dump -h localhost \
                   -U ${{ secrets.PROD_DB_USER }} \
                   -d ${{ secrets.PROD_DB_NAME }} > ~/db_sync/prod_dump.sql
            
            # Check if dump was created successfully
            if [ ! -s ~/db_sync/prod_dump.sql ]; then
              echo "❌ Failed to create database dump from production"
              exit 1
            fi
            
            echo "✅ Production database dump created successfully"
            
            # Step 2: Backup staging database before overwriting (safety measure)
            echo "Backing up staging database..."
            export PGPASSWORD=${{ secrets.STAGING_DB_PASSWORD }}
            BACKUP_TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
            BACKUP_DIR=~/staging_db_backups/$BACKUP_TIMESTAMP
            mkdir -p $BACKUP_DIR
            
            pg_dump -h localhost \
                   -U ${{ secrets.STAGING_DB_USER }} \
                   -d ${{ secrets.STAGING_DB_NAME }} > $BACKUP_DIR/staging_backup_before_sync.sql
            
            echo "✅ Staging database backup created at $BACKUP_DIR/staging_backup_before_sync.sql"
            
            # Step 3: Drop existing schema and restore to staging from production dump
            echo "Restoring production database to staging..."
            psql -h localhost \
                -U ${{ secrets.STAGING_DB_USER }} \
                -d ${{ secrets.STAGING_DB_NAME }} \
                -c "DROP SCHEMA public CASCADE; CREATE SCHEMA public;"
            
            psql -h localhost \
                -U ${{ secrets.STAGING_DB_USER }} \
                -d ${{ secrets.STAGING_DB_NAME }} < ~/db_sync/prod_dump.sql
            
            echo "✅ Database restored successfully from production to staging"
            
            # Step 4: Backup staging media files before syncing
            echo "Backing up staging media files..."
            MEDIA_BACKUP_DIR=~/staging_media_backups/$BACKUP_TIMESTAMP
            mkdir -p $MEDIA_BACKUP_DIR
            
            if [ -d "${{ secrets.STAGING_DEPLOY_PATH }}/public/media/" ]; then
              cp -r ${{ secrets.STAGING_DEPLOY_PATH }}/public/media/ $MEDIA_BACKUP_DIR/
              echo "✅ Staging media backup created at $MEDIA_BACKUP_DIR"
            else
              echo "⚠️ No media folder found in staging to backup"
              mkdir -p ${{ secrets.STAGING_DEPLOY_PATH }}/public/media/
            fi
            
            # Step 5: Sync media files from production to staging
            echo "Syncing media files from production to staging..."
            rsync -avz --delete ${{ secrets.PROD_DEPLOY_PATH }}/public/media/ ${{ secrets.STAGING_DEPLOY_PATH }}/public/media/
            
            echo "✅ Media files synced from production to staging"
            
            # Step 6: Clean up temporary files but keep the backups
            rm ~/db_sync/prod_dump.sql
            
            # Keep only the 5 most recent staging media backups to save space
            if [ -d ~/staging_media_backups ]; then
              ls -t ~/staging_media_backups | tail -n +6 | xargs -I {} rm -rf ~/staging_media_backups/{}
              echo "Cleaned up older staging media backups, keeping the 5 most recent ones"
            fi
            
            # Keep only the 10 most recent staging database backups
            if [ -d ~/staging_db_backups ]; then
              ls -t ~/staging_db_backups | tail -n +11 | xargs -I {} rm -rf ~/staging_db_backups/{}
              echo "Cleaned up older staging database backups, keeping the 10 most recent ones"
            fi
            
            # Step 7: Restart the PM2 process for staging to ensure it uses the new data
            echo "Restarting staging application..."
            pm2 restart ${{ secrets.STAGING_APP_NAME }}
            
            echo "✅ Staging database and media files updated successfully from production"
            
            # Document sync in changelog
            
            echo "$(date): Synced database and media from production to staging" >> ~/deployment_changelog.txt