name: Payload CMS Deployment

on:
  push:
    branches: ["main", "staging"]
    
jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20  # Add job-level timeout
    if: github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment variables for staging
        if: github.ref == 'refs/heads/staging'
        run: |
          echo "ENV_PREFIX=STAGING" >> $GITHUB_ENV
          echo "DEPLOY_PATH=${{ secrets.STAGING_DEPLOY_PATH }}" >> $GITHUB_ENV
          echo "APP_NAME=${{ secrets.STAGING_APP_NAME }}" >> $GITHUB_ENV
          echo "PORT=${{ secrets.STAGING_PORT }}" >> $GITHUB_ENV
          echo "NEXT_PUBLIC_ENVIRONMENT=staging" >> $GITHUB_ENV

      - name: Setup environment variables for production
        if: github.ref == 'refs/heads/main'
        run: |
          echo "ENV_PREFIX=PROD" >> $GITHUB_ENV
          echo "DEPLOY_PATH=${{ secrets.PROD_DEPLOY_PATH }}" >> $GITHUB_ENV
          echo "APP_NAME=${{ secrets.PROD_APP_NAME }}" >> $GITHUB_ENV
          echo "PORT=${{ secrets.PROD_PORT }}" >> $GITHUB_ENV
          echo "NEXT_PUBLIC_ENVIRONMENT=production" >> $GITHUB_ENV

      - name: Create environment file
        run: |
          echo "DATABASE_URI=${{ secrets[format('{0}_DATABASE_URI', env.ENV_PREFIX)] }}" > .env
          echo "PAYLOAD_SECRET=${{ secrets.PAYLOAD_SECRET }}" >> .env
          echo "NEXT_PUBLIC_SERVER_URL=${{ secrets[format('{0}_NEXT_PUBLIC_SERVER_URL', env.ENV_PREFIX)] }}" >> .env
          echo "NEXT_PUBLIC_SITE_URL=${{ secrets[format('{0}_NEXT_PUBLIC_SERVER_URL', env.ENV_PREFIX)] }}" >> .env
          echo "CRON_SECRET=${{ secrets.CRON_SECRET }}" >> .env
          echo "PREVIEW_SECRET=${{ secrets.PREVIEW_SECRET }}" >> .env
          echo "NEXT_PUBLIC_ENVIRONMENT=${{ env.NEXT_PUBLIC_ENVIRONMENT }}" >> .env
          echo "PORT=${{ env.PORT }}" >> .env
          echo "APP_NAME=${{ env.APP_NAME }}" >> .env

      - name: Deploy via rsync
        uses: burnett01/rsync-deployments@5.2
        with:
          switches: -avzr --delete --exclude='node_modules' --exclude='package.json.old' --exclude='.next' --exclude='public/media'
          path: ./
          remote_host: ${{ secrets.SERVER_HOST }}
          remote_user: ${{ secrets.SERVER_USER }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}
          remote_path: ${{ env.DEPLOY_PATH }}

      - name: Execute remote SSH commands
        uses: appleboy/ssh-action@master
        timeout-minutes: 15  # Add step-level timeout for the build process
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          command_timeout: 15m  # Add command timeout for the SSH action
          script: |
            # Load nvm and environment
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"
            
            source ~/.profile
            source ~/.bashrc
            
            cd ${{ env.DEPLOY_PATH }}
            
            # Package installation with error handling
            echo "Installing dependencies..."
            if ! npm ci; then
              echo "❌ npm ci failed"
              # Fall back to npm install if npm ci fails
              if ! npm install; then
                echo "❌ npm install failed"
                exit 1
              fi
            fi
            
            # Secure environment file
            chmod 600 .env
            
            # Database backup before migrations
            echo "Creating database backup before migration..."
            BACKUP_DIR=~/db_backups/$(date +"%Y%m%d_%H%M%S")
            mkdir -p $BACKUP_DIR
            
            # Use the explicitly defined DB credentials from secrets
            DB_NAME=${{ secrets[format('{0}_DB_NAME', env.ENV_PREFIX)] }}
            DB_USER=${{ secrets[format('{0}_DB_USER', env.ENV_PREFIX)] }}
            
            export PGPASSWORD="${{ secrets[format('{0}_DB_PASSWORD', env.ENV_PREFIX)] }}"
            pg_dump -h localhost -U $DB_USER -d $DB_NAME > $BACKUP_DIR/pre_migration_backup.sql
            
            echo "✅ Database backup created at $BACKUP_DIR/pre_migration_backup.sql"
            
            # Check for migration status
            echo "Checking migration status..."
            npm run migrate:status
            
            # Run database migrations with error handling
            echo "Running database migrations..."
            if ! npm run migrate; then
              echo "❌ Database migration failed"
              echo "Attempting rollback using backup..."
              psql -h localhost -U $DB_USER -d $DB_NAME -c "DROP SCHEMA public CASCADE; CREATE SCHEMA public;"
              psql -h localhost -U $DB_USER -d $DB_NAME < $BACKUP_DIR/pre_migration_backup.sql
              exit 1
            fi
            
            # Clear cache
            rm -rf .next
            
            # Set optimal memory for 2GB server (increased from 1536)
            export NODE_OPTIONS="--max-old-space-size=1792"
            
            echo "Starting build..."
            if ! NEXT_TELEMETRY_DISABLED=1 npm run build; then
              echo "❌ Build failed"
              exit 1
            fi
            
            # Start the application with PM2
            echo "Starting application with PM2..."
            # Check if the app is already running in PM2
            if pm2 list | grep -q "${{ env.APP_NAME }}"; then
              echo "Stopping existing PM2 process..."
              pm2 stop "${{ env.APP_NAME }}" || true
              pm2 delete "${{ env.APP_NAME }}" || true
            fi
            
            # Start the app with PM2
            if ! NODE_ENV=production PORT=${{ env.PORT }} pm2 start npm --name "${{ env.APP_NAME }}" -- start; then
              echo "❌ PM2 start failed"
              exit 1
            fi
            
            # Save PM2 configuration
            if ! pm2 save; then
              echo "❌ PM2 save failed, but app is running"
              # Continue anyway as this is non-critical
            fi
            
            echo "✅ Deployment completed successfully!"
            
            # Document migration in changelog
            echo "$(date): Deployed from ${{ github.ref }} with migrations" >> ~/deployment_changelog.txt