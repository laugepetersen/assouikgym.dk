name: Sync Staging to Production

on:
  workflow_dispatch:
    inputs:
      confirm_sync:
        description: 'Type "CONFIRM" to proceed with the sync from staging to production'
        required: true
        type: string

jobs:
  sync-to-production:
    runs-on: ubuntu-latest
    # Only run if the person who triggered the workflow is a repository owner/admin
    # AND they typed CONFIRM in the confirmation input
    
    if: ${{ github.event.inputs.confirm_sync == 'CONFIRM' }}
    
    steps:
      - name: Execute remote SSH commands to sync databases and media
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            # Load environment variables and profiles
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"
            
            source ~/.profile
            source ~/.bashrc
            
            # Create directory for database operations
            mkdir -p ~/db_sync
            
            # Step 1: Create a database dump from staging
            echo "Creating staging database dump..."
            export PGPASSWORD=${{ secrets.STAGING_DB_PASSWORD }}
            pg_dump -h localhost \
                   -U ${{ secrets.STAGING_DB_USER }} \
                   -d ${{ secrets.STAGING_DB_NAME }} > ~/db_sync/staging_dump.sql
            
            # Check if dump was created successfully
            if [ ! -s ~/db_sync/staging_dump.sql ]; then
              echo "❌ Failed to create database dump from staging"
              exit 1
            fi
            
            echo "✅ Staging database dump created successfully"
            
            # Step 2: Backup production database before overwriting (safety measure)
            echo "Backing up production database..."
            export PGPASSWORD=${{ secrets.PROD_DB_PASSWORD }}
            BACKUP_TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
            BACKUP_DIR=~/db_backups/$BACKUP_TIMESTAMP
            mkdir -p $BACKUP_DIR
            
            pg_dump -h localhost \
                   -U ${{ secrets.PROD_DB_USER }} \
                   -d ${{ secrets.PROD_DB_NAME }} > $BACKUP_DIR/prod_backup_before_sync.sql
            
            echo "✅ Production database backup created at $BACKUP_DIR/prod_backup_before_sync.sql"
            
            # Step 3: Drop existing schema and restore from staging dump
            echo "Restoring staging database to production..."
            psql -h localhost \
                -U ${{ secrets.PROD_DB_USER }} \
                -d ${{ secrets.PROD_DB_NAME }} \
                -c "DROP SCHEMA public CASCADE; CREATE SCHEMA public;"
            
            psql -h localhost \
                -U ${{ secrets.PROD_DB_USER }} \
                -d ${{ secrets.PROD_DB_NAME }} < ~/db_sync/staging_dump.sql
            
            echo "✅ Database restored successfully from staging to production"
            
            # Step 4: Backup production media files before syncing
            echo "Backing up production media files..."
            MEDIA_BACKUP_DIR=~/media_backups/$BACKUP_TIMESTAMP
            mkdir -p $MEDIA_BACKUP_DIR
            
            if [ -d "${{ secrets.PROD_DEPLOY_PATH }}/public/media/" ]; then
              cp -r ${{ secrets.PROD_DEPLOY_PATH }}/public/media/ $MEDIA_BACKUP_DIR/
              echo "✅ Production media backup created at $MEDIA_BACKUP_DIR"
            else
              echo "⚠️ No media folder found in production to backup"
              mkdir -p ${{ secrets.PROD_DEPLOY_PATH }}/public/media/
            fi
            
            # Step 5: Sync media files from staging to production
            echo "Syncing media files from staging to production..."
            rsync -avz --delete ${{ secrets.STAGING_DEPLOY_PATH }}/public/media/ ${{ secrets.PROD_DEPLOY_PATH }}/public/media/
            
            echo "✅ Media files synced from staging to production"
            
            # Step 6: Clean up temporary files but keep the backups
            rm ~/db_sync/staging_dump.sql
            
            # Keep only the 5 most recent media backups to save space
            if [ -d ~/media_backups ]; then
              ls -t ~/media_backups | tail -n +6 | xargs -I {} rm -rf ~/media_backups/{}
              echo "Cleaned up older media backups, keeping the 5 most recent ones"
            fi
            
            # Keep only the 10 most recent database backups
            if [ -d ~/db_backups ]; then
              ls -t ~/db_backups | tail -n +11 | xargs -I {} rm -rf ~/db_backups/{}
              echo "Cleaned up older database backups, keeping the 10 most recent ones"
            fi
            
            # Step 7: Restart the PM2 process for production to ensure it uses the new data
            echo "Restarting production application..."
            pm2 restart ${{ secrets.PROD_APP_NAME }}
            
            echo "✅ Production database and media files updated successfully from staging"
            
            # Document sync in changelog
            
            echo "$(date): Synced database and media from staging to production" >> ~/deployment_changelog.txt